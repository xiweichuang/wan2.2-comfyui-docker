name: Build and Push Docker Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ===== æ„å»ºå‰ç£ç›˜ç©ºé—´ =====
      - name: ç£ç›˜ç©ºé—´ï¼ˆæ„å»ºå‰ï¼‰
        run: |
          echo "ğŸ“¦ æ„å»ºå‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -h

      # ğŸ”¥ é‡Šæ”¾ GitHub Actions ç£ç›˜ç©ºé—´
      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      # ===== é‡Šæ”¾åç£ç›˜ç©ºé—´ =====
      - name: ç£ç›˜ç©ºé—´ï¼ˆæ¸…ç†åï¼‰
        run: |
          echo "ğŸ§¹ æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -h

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ===== æ„å»ºå¹¶æ¨é€é•œåƒ =====
      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/comfyui-wan2.2:latest
          provenance: false

      # ===== æ„å»ºåç£ç›˜ç©ºé—´ =====
      - name: ç£ç›˜ç©ºé—´ï¼ˆæ„å»ºåï¼‰
        run: |
          echo "ğŸ“Š æ„å»ºå®Œæˆåç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -h

      # ===== Docker é•œåƒå¤§å° =====
      - name: Docker é•œåƒä½“ç§¯ç»Ÿè®¡
        run: |
          echo "ğŸ³ å½“å‰ Docker é•œåƒåˆ—è¡¨ï¼š"
          docker images | grep comfyui-wan2.2 || true

          echo ""
          echo "ğŸ“¦ é•œåƒè¯¦ç»†ä½“ç§¯ä¿¡æ¯ï¼š"
          IMAGE_ID=$(docker images ghcr.io/${{ github.repository_owner }}/comfyui-wan2.2:latest --quiet)
          if [ -n "$IMAGE_ID" ]; then
            docker image inspect $IMAGE_ID --format='
            é•œåƒ ID: {{.Id}}
            å®é™…å¤§å°: {{printf "%.2f" (div .Size 1073741824)}} GB
            '
          else
            echo "âš ï¸ æœ¬åœ°æœªæ‰¾åˆ°é•œåƒï¼ˆå¯èƒ½å·²è¢«æ¸…ç†æˆ–åªæ¨é€æœªä¿ç•™ï¼‰"
          fi
